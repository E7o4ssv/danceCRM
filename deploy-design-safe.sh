#!/bin/bash

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π –¥–∏–∑–∞–π–Ω–∞ —Ç–∞–Ω—Ü–µ–≤–∞–ª—å–Ω–æ–π —à–∫–æ–ª—ã
# –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω

set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üé® –ù–∞—á–∏–Ω–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π –¥–∏–∑–∞–π–Ω–∞..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
    exit 1
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

info() {
    echo -e "${BLUE}[INFO] $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    error "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞"
fi

log "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º git —Å—Ç–∞—Ç—É—Å
if [ -n "$(git status --porcelain)" ]; then
    warning "–ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    git status --short
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        error "–î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω"
    fi
fi

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
log "–°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
BACKUP_DIR="backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

# –ö–æ–ø–∏—Ä—É–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
cp -r client/src "$BACKUP_DIR/"
cp -r server "$BACKUP_DIR/"
cp package.json "$BACKUP_DIR/"
cp client/package.json "$BACKUP_DIR/"

log "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ $BACKUP_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
log "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
cd client
if [ ! -d "node_modules" ]; then
    log "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞..."
    npm install
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Tailwind CSS
if [ ! -f "tailwind.config.js" ]; then
    error "Tailwind CSS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
fi

cd ..

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
if [ ! -d "node_modules" ]; then
    log "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
    npm install
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –∫–ª–∏–µ–Ω—Ç–∞
log "–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É –∫–ª–∏–µ–Ω—Ç–∞..."
cd client
npm run build
if [ $? -ne 0 ]; then
    error "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞"
fi
cd ..

# –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ
log "–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä..."
timeout 10s npm run server > /dev/null 2>&1 &
SERVER_PID=$!
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! kill -0 $SERVER_PID 2>/dev/null; then
    error "–°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º API
log "–¢–µ—Å—Ç–∏—Ä—É–µ–º API..."
if curl -s http://localhost:3001/api/health > /dev/null; then
    log "API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    warning "API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
kill $SERVER_PID 2>/dev/null || true

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é
log "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f ".env" ]; then
    warning "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    if [ -f "env.example" ]; then
        log "–ö–æ–ø–∏—Ä—É–µ–º env.example –≤ .env"
        cp env.example .env
    fi
fi

# –°–æ–∑–¥–∞–µ–º production build
log "–°–æ–∑–¥–∞–µ–º production build..."
cd client
npm run build
cd ..

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ build —Å–æ–∑–¥–∞–ª—Å—è
if [ ! -d "client/build" ]; then
    error "Production build –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è"
fi

log "Production build —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"

# –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –¥–ª—è –¥–µ–ø–ª–æ—è
log "–°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –¥–ª—è –¥–µ–ø–ª–æ—è..."
DEPLOY_ARCHIVE="dance-school-design-$(date +%Y%m%d-%H%M%S).tar.gz"
tar -czf "$DEPLOY_ARCHIVE" \
    --exclude=node_modules \
    --exclude=.git \
    --exclude=backup-* \
    --exclude=*.log \
    .

log "–ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $DEPLOY_ARCHIVE"

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –¥–µ–ø–ª–æ—è
echo ""
echo "üéØ –ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ!"
echo ""
echo "üì¶ –ê—Ä—Ö–∏–≤: $DEPLOY_ARCHIVE"
echo "üìÅ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: $BACKUP_DIR"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
echo "2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤"
echo "3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: npm install"
echo "4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞: cd client && npm install"
echo "5. –°–æ–∑–¥–∞–π—Ç–µ production build: cd client && npm run build"
echo "6. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: npm start"
echo ""
echo "üîß –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:"
echo "- client/build/ (production build)"
echo "- server/ (backend –∫–æ–¥)"
echo "- .env (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)"
echo ""
echo "‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ:"
echo "- –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
echo "- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –¥–ª—è –¥–æ–º–µ–Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞"
echo ""

log "–î–µ–ø–ª–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üöÄ" 